<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #f0f0f0;
				margin: 0px;
				overflow: hidden;
			}
			#info {
				position: absolute;
				top: 0px;
				width: 100%;
				padding: 5px;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
			}
		</style>
	</head>
	<body>

		<div id="container"></div>
		<script src="/libs/three.min.js"></script>
		<script>
		var container;
		var camera, scene, renderer, splineCamera;
		var binormal = new THREE.Vector3();
		var normal = new THREE.Vector3();
		var pipeSpline = new THREE.CatmullRomCurve3( [
				new THREE.Vector3( 0, 10, -10 ), new THREE.Vector3( 10, 0, -10 ),
				new THREE.Vector3( 20, 0, 0 ), new THREE.Vector3( 30, 0, 10 ),
				new THREE.Vector3( 30, 0, 20 ), new THREE.Vector3( 20, 0, 30 ),
				new THREE.Vector3( 10, 0, 30 ), new THREE.Vector3( 0, 0, 30 ),
				new THREE.Vector3( -10, 10, 30 ), new THREE.Vector3( -10, 20, 30 ),
				new THREE.Vector3( 0, 30, 30 ), new THREE.Vector3( 10, 30, 30 ),
				new THREE.Vector3( 20, 30, 15 ), new THREE.Vector3( 10, 30, 10 ),
				new THREE.Vector3( 0, 30, 10 ), new THREE.Vector3( -10, 20, 10 ),
				new THREE.Vector3( -10, 10, 10 ), new THREE.Vector3( 0, 0, 10 ),
				new THREE.Vector3( 10, -10, 10 ), new THREE.Vector3( 20, -15, 10 ),
				new THREE.Vector3( 30, -15, 10 ), new THREE.Vector3( 40, -15, 10 ),
				new THREE.Vector3( 50, -15, 10 ), new THREE.Vector3( 60, 0, 10 ),
				new THREE.Vector3( 70, 0, 0 ), new THREE.Vector3( 80, 0, 0 ),
				new THREE.Vector3( 90, 0, 0 ), new THREE.Vector3( 100, 0, 0 )
		] );
		var sampleClosedSpline = new THREE.CatmullRomCurve3( [
			new THREE.Vector3( 0, -40, -40 ),
			new THREE.Vector3( 0, 40, -40 ),
			new THREE.Vector3( 0, 140, -40 ),
			new THREE.Vector3( 0, 40, 40 ),
			new THREE.Vector3( 0, -40, 40 )
		] );
		sampleClosedSpline.type = 'catmullrom';
		sampleClosedSpline.closed = false;
		// Keep a dictionary of Curve instances
		var splines = {
			PipeSpline: pipeSpline,
			SampleClosedSpline: sampleClosedSpline
		};
		var parent, tubeGeometry, group;
		var params = {
			spline: 'PipeSpline',
			scale: 0.5,
			extrusionSegments: 150,
			radiusSegments: 2,
			closed: false,
			animationView: false,
			lookAhead: false,
			cameraHelper: false,
		};
		var material = new THREE.MeshLambertMaterial( { color: 0xff00ff } );
		var wireframeMaterial = new THREE.MeshBasicMaterial( { color: 0x000000, opacity: 0.3, wireframe: false, transparent: true } );
		var jsonDataBaseFile = JSON.parse(fs.readFileSync("bodyfail.json"));
		function addTube(x, y, index) {
			var jsonDataBase = jsonDataBaseFile[index];
			var extrudePath = new THREE.CatmullRomCurve3([
				new THREE.Vector3(jsonDataBase.skeleton.n0.x, jsonDataBase.skeleton.n0.y, jsonDataBase.skeleton.n0.z),
				new THREE.Vector3(jsonDataBase.skeleton.n1.x, jsonDataBase.skeleton.n1.y, jsonDataBase.skeleton.n1.z),
				new THREE.Vector3(jsonDataBase.skeleton.n20.x, jsonDataBase.skeleton.n20.y, jsonDataBase.skeleton.n20.z),
				new THREE.Vector3(jsonDataBase.skeleton.n2.x, jsonDataBase.skeleton.n2.y, jsonDataBase.skeleton.n2.z),
				new THREE.Vector3(jsonDataBase.skeleton.n3.x, jsonDataBase.skeleton.n3.y, jsonDataBase.skeleton.n3.z),

			]);
			tubeGeometry = new THREE.TubeBufferGeometry( extrudePath, params.extrusionSegments, 2, params.radiusSegments, params.closed );
			tubeGeometry.translate(x * 190 - 900, y * (-200) + 500, 0);
			addGeometry( tubeGeometry );
			extrudePath = new THREE.CatmullRomCurve3([
				new THREE.Vector3(jsonDataBase.skeleton.n8.x, jsonDataBase.skeleton.n8.y, jsonDataBase.skeleton.n8.z),
				new THREE.Vector3(jsonDataBase.skeleton.n9.x, jsonDataBase.skeleton.n9.y, jsonDataBase.skeleton.n9.z),
				new THREE.Vector3(jsonDataBase.skeleton.n10.x, jsonDataBase.skeleton.n10.y, jsonDataBase.skeleton.n10.z),
				new THREE.Vector3(jsonDataBase.skeleton.n11.x, jsonDataBase.skeleton.n11.y, jsonDataBase.skeleton.n11.z),
				new THREE.Vector3(jsonDataBase.skeleton.n23.x, jsonDataBase.skeleton.n23.y, jsonDataBase.skeleton.n23.z),

			]);
			tubeGeometry = new THREE.TubeBufferGeometry( extrudePath, params.extrusionSegments, 2, params.radiusSegments, params.closed );
			tubeGeometry.translate(x * 190 - 900, y * (-200) + 500, 0);
			addGeometry( tubeGeometry );
			extrudePath = new THREE.CatmullRomCurve3([
				new THREE.Vector3(jsonDataBase.skeleton.n4.x, jsonDataBase.skeleton.n4.y, jsonDataBase.skeleton.n4.z),
				new THREE.Vector3(jsonDataBase.skeleton.n5.x, jsonDataBase.skeleton.n5.y, jsonDataBase.skeleton.n5.z),
				new THREE.Vector3(jsonDataBase.skeleton.n6.x, jsonDataBase.skeleton.n6.y, jsonDataBase.skeleton.n6.z),
				new THREE.Vector3(jsonDataBase.skeleton.n7.x, jsonDataBase.skeleton.n7.y, jsonDataBase.skeleton.n7.z),
				new THREE.Vector3(jsonDataBase.skeleton.n21.x, jsonDataBase.skeleton.n21.y, jsonDataBase.skeleton.n21.z),

			]);
			tubeGeometry = new THREE.TubeBufferGeometry( extrudePath, params.extrusionSegments, 2, params.radiusSegments, params.closed );
			tubeGeometry.translate(x * 190 - 900, y * (-200) + 500, 0);
			addGeometry( tubeGeometry );
			extrudePath = new THREE.CatmullRomCurve3([
				new THREE.Vector3(jsonDataBase.skeleton.n8.x, jsonDataBase.skeleton.n8.y, jsonDataBase.skeleton.n8.z),
				new THREE.Vector3(jsonDataBase.skeleton.n20.x, jsonDataBase.skeleton.n20.y, jsonDataBase.skeleton.n20.z),
				new THREE.Vector3(jsonDataBase.skeleton.n4.x, jsonDataBase.skeleton.n4.y, jsonDataBase.skeleton.n4.z),
			]);
			tubeGeometry = new THREE.TubeBufferGeometry( extrudePath, params.extrusionSegments, 2, params.radiusSegments, params.closed );
			tubeGeometry.translate(x * 190 - 900, y * (-200) + 500, 0);
			addGeometry( tubeGeometry );
			extrudePath = new THREE.CatmullRomCurve3([
				new THREE.Vector3(jsonDataBase.skeleton.n16.x, jsonDataBase.skeleton.n16.y, jsonDataBase.skeleton.n16.z),
				new THREE.Vector3(jsonDataBase.skeleton.n0.x, jsonDataBase.skeleton.n0.y, jsonDataBase.skeleton.n0.z),
				new THREE.Vector3(jsonDataBase.skeleton.n12.x, jsonDataBase.skeleton.n12.y, jsonDataBase.skeleton.n12.z),
			]);
			tubeGeometry = new THREE.TubeBufferGeometry( extrudePath, params.extrusionSegments, 2, params.radiusSegments, params.closed );
			tubeGeometry.translate(x * 190 - 900, y * (-200) + 500, 0);
			addGeometry( tubeGeometry );
			extrudePath = new THREE.CatmullRomCurve3([
				new THREE.Vector3(jsonDataBase.skeleton.n16.x, jsonDataBase.skeleton.n16.y, jsonDataBase.skeleton.n16.z),
				new THREE.Vector3(jsonDataBase.skeleton.n17.x, jsonDataBase.skeleton.n17.y, jsonDataBase.skeleton.n17.z),
				new THREE.Vector3(jsonDataBase.skeleton.n18.x, jsonDataBase.skeleton.n18.y, jsonDataBase.skeleton.n18.z),
			]);
			tubeGeometry = new THREE.TubeBufferGeometry( extrudePath, params.extrusionSegments, 2, params.radiusSegments, params.closed );
			tubeGeometry.translate(x * 190 - 900, y * (-200) + 500, 0);
			addGeometry( tubeGeometry );
			extrudePath = new THREE.CatmullRomCurve3([
				new THREE.Vector3(jsonDataBase.skeleton.n12.x, jsonDataBase.skeleton.n12.y, jsonDataBase.skeleton.n12.z),
				new THREE.Vector3(jsonDataBase.skeleton.n13.x, jsonDataBase.skeleton.n13.y, jsonDataBase.skeleton.n13.z),
				new THREE.Vector3(jsonDataBase.skeleton.n14.x, jsonDataBase.skeleton.n14.y, jsonDataBase.skeleton.n14.z),
			]);
			tubeGeometry = new THREE.TubeBufferGeometry( extrudePath, params.extrusionSegments, 2, params.radiusSegments, params.closed );
			tubeGeometry.translate(x * 190 - 900, y * (-200) + 500, 0);
			addGeometry( tubeGeometry );
			extrudePath = new THREE.CatmullRomCurve3([
				new THREE.Vector3(jsonDataBase.skeleton.n10.x, jsonDataBase.skeleton.n10.y, jsonDataBase.skeleton.n10.z),
				new THREE.Vector3(jsonDataBase.skeleton.n24.x, jsonDataBase.skeleton.n24.y, jsonDataBase.skeleton.n24.z),
			]);
			tubeGeometry = new THREE.TubeBufferGeometry( extrudePath, params.extrusionSegments, 2, params.radiusSegments, params.closed );
			tubeGeometry.translate(x * 190 - 900, y * (-200) + 500, 0);
			addGeometry( tubeGeometry );
			extrudePath = new THREE.CatmullRomCurve3([
				new THREE.Vector3(jsonDataBase.skeleton.n6.x, jsonDataBase.skeleton.n6.y, jsonDataBase.skeleton.n6.z),
				new THREE.Vector3(jsonDataBase.skeleton.n22.x, jsonDataBase.skeleton.n22.y, jsonDataBase.skeleton.n22.z),
			]);
			tubeGeometry = new THREE.TubeBufferGeometry( extrudePath, params.extrusionSegments, 2, params.radiusSegments, params.closed );
			tubeGeometry.translate(x * 190 - 900, y * (-200) + 500, 0);
			addGeometry( tubeGeometry );
			extrudePath = new THREE.CatmullRomCurve3([
				new THREE.Vector3(jsonDataBase.skeleton.n18.x, jsonDataBase.skeleton.n18.y, jsonDataBase.skeleton.n18.z),
				new THREE.Vector3(jsonDataBase.skeleton.n19.x, jsonDataBase.skeleton.n19.y, jsonDataBase.skeleton.n19.z),
			]);
			tubeGeometry = new THREE.TubeBufferGeometry( extrudePath, params.extrusionSegments, 2, params.radiusSegments, params.closed );
			tubeGeometry.translate(x * 190 - 900, y * (-200) + 500, 0);
			addGeometry( tubeGeometry );
			extrudePath = new THREE.CatmullRomCurve3([
				new THREE.Vector3(jsonDataBase.skeleton.n14.x, jsonDataBase.skeleton.n14.y, jsonDataBase.skeleton.n14.z),
				new THREE.Vector3(jsonDataBase.skeleton.n15.x, jsonDataBase.skeleton.n15.y, jsonDataBase.skeleton.n15.z),
			]);
			tubeGeometry = new THREE.TubeBufferGeometry( extrudePath, params.extrusionSegments, 2, params.radiusSegments, params.closed );
			tubeGeometry.translate(x * 190 - 900, y * (-200) + 500, 0);
			addGeometry( tubeGeometry );
			setScale();
		}
		function setScale() {
			group.scale.set( params.scale, params.scale, params.scale );
		}
		function addGeometry( geometry ) {
			// 3D shape
			group = THREE.SceneUtils.createMultiMaterialObject( geometry, [ material, wireframeMaterial ] );
			parent.add( group );
		}
		init();
		render();
		function init() {
			container = document.getElementById( 'container' );
			// camera
			camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 0.01, 10000 );
			camera.position.set( 0, 50, 500 );
			// scene
			scene = new THREE.Scene();
			scene.background = new THREE.Color( 0xf0f0f0 );
			// light
			var light = new THREE.DirectionalLight( 0xffffff );
			light.position.set( 0, 0, 1 );
			scene.add( light );
			// tube
			parent = new THREE.Object3D();
			scene.add( parent );
			splineCamera = new THREE.PerspectiveCamera( 84, window.innerWidth / window.innerHeight, 0.01, 1000 );
			parent.add( splineCamera );
			var index = 0;
			for (var i = 0; i < 10; i++)
			{
				for (var j = 0; j < 5; j++)
				{
					addTube(i, j, index);
					index++;
				}
			}
			// renderer
			renderer = new THREE.WebGLRenderer( { antialias: true } );
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );
			container.appendChild( renderer.domElement );

			// event listener
			window.addEventListener( 'resize', onWindowResize, false );
		}
		function onWindowResize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize( window.innerWidth, window.innerHeight );
		}
		function render() {
			// animate camera along spline
			var time = Date.now();
			var looptime = 20 * 1000;
			var t = ( time % looptime ) / looptime;
			var pos = tubeGeometry.parameters.path.getPointAt( t );
			pos.multiplyScalar( params.scale );
			// interpolation
			var segments = tubeGeometry.tangents.length;
			var pickt = t * segments;
			var pick = Math.floor( pickt );
			var pickNext = ( pick + 1 ) % segments;
			binormal.subVectors( tubeGeometry.binormals[ pickNext ], tubeGeometry.binormals[ pick ] );
			binormal.multiplyScalar( pickt - pick ).add( tubeGeometry.binormals[ pick ] );
			var dir = tubeGeometry.parameters.path.getTangentAt( t );
			var offset = 15;
			normal.copy( binormal ).cross( dir );
			// we move on a offset on its binormal
			pos.add( normal.clone().multiplyScalar( offset ) );
			splineCamera.position.copy( pos );
			// using arclength for stablization in look ahead
			var lookAt = tubeGeometry.parameters.path.getPointAt( ( t + 30 / tubeGeometry.parameters.path.getLength() ) % 1 ).multiplyScalar( params.scale );
			// camera orientation 2 - up orientation via normal
			if ( ! params.lookAhead ) lookAt.copy( pos ).add( dir );
			splineCamera.matrix.lookAt( splineCamera.position, lookAt, normal );
			splineCamera.rotation.setFromRotationMatrix( splineCamera.matrix, splineCamera.rotation.order );
//			cameraHelper.update();
			renderer.render( scene, params.animationView === true ? splineCamera : camera );
		}
	</script>
	</body>
</html>